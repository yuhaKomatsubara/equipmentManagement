<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"> <!--thymeleafの宣言-->

<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" th:href="@{/css/circulationLayout.css}">
	<title>貸出</title>
</head>

<body class="body">
	<h2 class="title">備品貸出画面</h2>
	<br>
	<h2 th:text="${detailName.equipmentName}"></h2>

	<!-- エラーメッセージヘッダー表示 -->
	<div th:if="${errorMessages != null and errorMessages.size() > 0}">
		<h4 class="fc_red">以下のエラーが発生しました。</h4>
		<h4 class="fc_red">更新できませんでした。再度入力してください。</h4>
	</div>

	<!-- エラーメッセージ表示 -->
	<div class="error-box" th:if="${errorMessages}">
		<ul class="error-list">
			<li th:each="msg : ${errorMessages}" th:text="${msg}"
				th:classappend="${msg.startsWith('【') ? 'error-title' : ''}">
			</li>
		</ul>
	</div>

	<!-- 貸出成功メッセージ表示 -->
	<h4 class="success-message" th:if="${updateMessage}" th:text="${updateMessage}"></h4>

	<!-- 入れ子フォームを避けるため、テーブルとボタンを .table-wrapper に入れる -->
	<div>
		<!-- テーブルだけスクロール -->
		<div class="table-wrapper">
			<form id="borrowForm" th:action="@{/borrowingProcess}" method="post"
				th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">
				<input type="hidden" name="name" th:value="${detailName.equipmentName}">
				<table border="1" class="borrow-table">
					<colgroup>
						<col class="col-serial">
						<col class="col-user">
						<col class="col-start">
						<col class="col-limit">
						<col class="col-remarks">
						<col class="col-check">
					</colgroup>

					<tr class="front_label_color">
						<th>シリアルナンバー</th>
						<th>使用者</th>
						<th>貸出開始日</th>
						<th>返却予定日</th>
						<th>備考</th>
						<th>貸出</th>
					</tr>

					<!-- 備品リスト表示 -->
					<!-- エラー行は赤背景、正常行は黄背景 -->
					<tr th:each="item : ${itemDetail}"
						th:classappend="${errorEquipmentIds != null and errorEquipmentIds.contains(item.equipmentId) ? 'row-error' : 
					                     (normalEquipmentIds != null and normalEquipmentIds.contains(item.equipmentId) ? 'row-normal' : '')}">

						<!-- シリアルナンバー -->
						<td class="col-serial">
							<!-- シリアルナンバー表示 -->
							<span th:text="${item.parentStockCode}"></span>
							<!-- シリアルナンバーをhiddenで送信 -->
							<input type="hidden" th:name="|serialMap[${item.equipmentId}]|"
								th:value="${item.parentStockCode}">
						</td>

						<!-- 使用者選択 -->
						<td class="col-user">
							<!-- プルダウン選択 -->
							<select th:name="|staffNoMap[${item.equipmentId}]|">
								<option value="">選択してください</option>
								<!-- スタッフ名をループで表示 -->
								<option th:each="staff : ${staffName}" th:value="${staff.staffNo}"
									th:text="${staff.name}" th:selected="${prevStaffNoMap != null 
					                    and prevStaffNoMap[item.equipmentId.toString()] == staff.staffNo.toString()}">
								</option>
							</select>
						</td>

						<!-- 貸出開始日・返却予定日入力 -->
						<td class="col-start">
							<!-- 今日の日付をデフォルト値として設定 -->
							<input type="date" th:name="|startDateMap[${item.equipmentId}]|" th:value="${prevStartDateMap != null and prevStartDateMap[item.equipmentId.toString()] != null
					                     ? prevStartDateMap[item.equipmentId.toString()]
					                     : today}">
						</td>

						<!-- 返却予定日 -->
						<td class="col-limit">
							<!-- デフォルトの返却予定日を設定 -->
							<input type="date" th:name="|limitDateMap[${item.equipmentId}]|" th:value="${prevLimitDateMap != null and prevLimitDateMap[item.equipmentId.toString()] != null
					                     ? prevLimitDateMap[item.equipmentId.toString()]
					                     : defaultLimit}">
						</td>
						
                        <!-- 備考 -->
						<td class="col-remarks">
							<div class="scroll-inner">
								<p th:text="${item.remarks}"></p>
							</div>
						</td>

						<!-- 貸出チェックボックス -->
						<td class="col-check">
							<input type="checkbox" name="equipmentIdList" th:value="${item.equipmentId}" th:checked="${prevEquipmentIdList != null
					                     and prevEquipmentIdList.contains(item.equipmentId)}">
						</td>
					</tr>
				</table>
			</form>
		</div>

		<!-- 貸出できる備品がないとき -->
		<h4 class="no-data" th:if="${itemDetail == null or #lists.isEmpty(itemDetail)}">
			全て貸出中です
		</h4>
		
        <!-- テーブル下のボタン -->
		<div class="table-buttons">
			<!-- 貸出ボタン（貸出できる備品があるときのみ表示） -->
			<button class="borrowingButton" type="submit" form="borrowForm"
				th:if="${itemDetail != null and !#lists.isEmpty(itemDetail)}">貸出</button>
				<!-- 戻るボタン -->
			<form th:action="@{/detailBack}" method="get">
				<input type="hidden" name="name" th:value="${detailName.equipmentName}">
				<button class="returnToTopButton" type="submit">戻る</button>
			</form>
		</div>
	</div>




	<script>
		//画面を読み込み時に実行
		document.addEventListener("DOMContentLoaded", function () {

			// 貸出ボタン押下時の処理
			document.getElementById("borrowForm").addEventListener("submit", function (e) {

				// 今日の日付を取得し、時分秒ミリ秒を0に設定
				const today = new Date();
				today.setHours(0, 0, 0, 0);

				// 貸出開始日が本日より前の日付があるかどうかのフラグ
				let isBeforeToday = false;

				// テーブルの各行をループ処理
				document.querySelectorAll("tr").forEach(tr => {
					// チェックボックスが選択されていない行はスキップ
					const checkbox = tr.querySelector('input[name="equipmentIdList"]');
					if (!checkbox || !checkbox.checked) return;

					// 貸出開始日の入力フィールドを取得し、値がない場合はスキップ
					const startInput = tr.querySelector('input[name^="startDateMap"]');
					if (!startInput || !startInput.value) return;

					// 貸出開始日をDateオブジェクトに変換し、本日より前かどうかをチェック
					const startDate = new Date(startInput.value);

					// 時分秒ミリ秒を0に設定
					if (startDate < today) {
						isBeforeToday = true;
					}
				});

				// YES 
				if (isBeforeToday) {
					//confirm(はい・いいえ)
					const result = confirm("貸出開始日が本日より前ですが、更新しますか？");

					if (!result) {
						e.preventDefault(); // NO
					}
				}

			});

		});
	</script>


</body>

</html>